## Exercise 2. Deploying the model using Flask framework locally and on Azure App Service. Setting up Email Automation Workflow on Azure Logic.

In this exercise, you will deploy the model using Flask framework locally and also from Azure app service. You will also trigger the Azure Logic App workflow by sending the High level priorty mail to the ODL user.

### Task 1 : Deploy the model by running the Flask wrapper locally

1. Navigate to **Microsoft Azure Machine Learning Studio** and click on **Open Terminal**.

   ![](Images/terminal.png)
   
1. Navigate to the required path by running the below given command on the Terminal page:

    ```
    cd artifacts/openai-model
    ```
1. Run the below mentioned command to run the Flask wrapper and copy the generated local host URl:

   ```
   flask run
   ```
   ![](Images/localhosturl.png)
   
### Task 2: Test the locally-deployed API with specified request/response formats

1. Navigate to the **notebooks** folder, select **flask-app-local-test.ipynb (1)** file and select the kernal as **Python 3.8-AzureML (2)**.

   ![](Images/testapplocally.png)
    
1. Run each cell one after the other and observe the output. 

   ![](Images/testapplocally1.png)
    
### Task 3: Deploy the model on Azure App Service

1. In Azure Machine Learning Studio, open a new terminal and run the below given commands:

   ```
   cd artifacts/openai-model
   ```
   
   ![](Images/artifacts.png)
   
   - RUn the below commands to folder as Zip file
   
   ```
   zip -r openai-model.zip .
   ```
   
   - Run the below command to login into the azure portal.
   ```
   az login --identity
   ```
   
   ![](Images/loginidentity.png)

   
   - Before running the below command update `<DID>` with **<inject key="DeploymentID" enableCopy="false"/>**.
   
   ```
   az webapp deploy --resource-group ODL-AzureAI-MS-<DID> --name openaiwebapp<DID> --src-path openai-model.zip --type=startup
   ```
   
   - After running the commands successfully, you can observe the **openai-model.zip** file under **artifacts** folder.
   
   ![](Images/openaizip.png)
   
   - Copy the web app URL and note it down in a Notepad. You will be using it in coming task.
   
   ![](Images/appURL.png)
   
### Task 4: Test the cloud-deployed API with specified request/response formats

1. Navigate to the **notebooks** folder, select **flask-app-test-appservice.ipynb (1)** file and select the kernal as **Python 3.8-Jupyter (2)**.

   ![](/Images/testappservice.png)
    
1. Run each cell one after the other and observe the output. Make sure you update the **SUFFIX** with the value **<inject key="DeploymentID" enableCopy="false"/>**.

   ![](Images/webapptest1.png)

### Task 5 : Setup email automation workflow on Azure Logic Apps using

1. Navigate back to the Azure Portal and from the **Overview (1)** page of resource group select **Office 365 (2)** API connection.

   ![](Images/office365.png)
   
1. Click on **Edit API Connection (1)** and click on **Authorize (2)**.

   ![](Images/editapi.png)
   
1. Select your Azure account to sign in.

   ![](Images/chooseaccount1.png)
   
1. Click on **Save**.

    ![](Images/saveapi.png)

1. Navigate back to resource group and from the **Overview (1)** page of resource group select **azureblob (2)** API connection.

    ![](Images/azureblob.png)
    
1. On azureblob API connection page, follow the below mentioned instruction : 

    - Click on **Edit API connection (1)**
    - **Azure Storage account name or blob endpoint** :  Enter **mlstorageaccount<inject key="DeploymentID" enableCopy="false"/> (2)**
    - **Azure Storage Account Access Key** : Enter **<inject key="StorageaccountKey" enableCopy="true"/> (3)**
    - Click on **Save (4)**

    ![](Images/editapiblo.png)

1. From Azure Portal, navigate to Logic app **openai-logicapp-<inject key="DeploymentID" enableCopy="false"/>** and click on **Enable**.

    ![](Images/enable.png)
    
3. Navigate to the URL `https://outlook.live.com/owa/` and click on  **Signin**.

    ![](Images/signin.png)
    
1. On the **Sign into Microsoft Azure** tab, you will see the login screen, enter the following username, and, then click on **Next**.

   * Email/Username: <inject key="AzureAdUserEmail"></inject>

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/raw/main/media/M2-Ex1-portalsignin-1.png?raw=true)

3. Now enter the following password and click on **Sign in**. 

   * Password: <inject key="AzureAdUserPassword"></inject>

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex1-portalsignin-2.png?raw=true)

1. Now, send an **High level importance** email to the below user account by attaching **Document** pdf file in the mail from the path **C:\LabFiles\artifacts\openai-model\data**.

    * Email/Username: <inject key="AzureAdUserEmail"></inject>
    
    ![](Images/highimportance.png)
    
1. Next, open the mail that is being triggered by the flow and review it.

    ![](Images/reviewmail.png)
    
1. Now, return to Azure portal where the logic app page is opened and click on **Runs histroy (1)** then review that the run status as in **Succeeded (2)**.

    ![](Images/runhisory.png)
